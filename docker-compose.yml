version: "3.3"

services:

  api:
    build:
      context: .
    image: nord-dns
    env_file: docker-compose.env
    environment:
      SERVICES: api
      PORT: 3000
    depends_on:
      - nats
    labels:
      # Docker specific labels https://doc.traefik.io/traefik/routing/providers/docker/#specific-provider-options
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # The domain the service will respond to Host AND Path
      # - traefik.http.routers.api.rule=Host(`localhost.local.ndns.cf`) && PathPrefix(`/`)
      - traefik.http.routers.api.rule=PathPrefix(`/`)
      # Allow request only from the predefined entry point named "websecure"
      - traefik.http.routers.api.entrypoints=websecure
      # Use TLS between the API service and Traefik
      - traefik.http.routers.api.tls=true
      # Tell Traefik to use the port 3000 to connect to `api` service
      - traefik.http.services.api.loadbalancer.server.port=3000
      - traefik.http.services.api.loadBalancer.server.scheme=https
    networks:
      - internal
  
  redis:
    image: redis:alpine
    entrypoint: redis-server
    networks:
      - internal

  doh:
    build:
      context: .
    image: nord-dns
    env_file: docker-compose.env
    environment:
      SERVICES: doh
    depends_on:
      - nats
    labels:
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # Allow request only from the predefined entry point named "websecure"
      - traefik.http.routers.dot.entrypoints=dot-socket
      # Use TLS between the API service and Traefik
      - traefik.http.routers.dot.tls=true
      # Tell Traefik to use the port 853 to connect to `dot` service
      - traefik.http.services.dot.loadbalancer.server.port=853
    networks:
      - internal

  dot:
    build:
      context: .
    image: nord-dns
    env_file: docker-compose.env
    environment:
      SERVICES: dot
    depends_on:
      - nats
    networks:
      - internal

  filter:
    build:
      context: .
    image: nord-dns
    env_file: docker-compose.env
    environment:
      SERVICES: filter
    depends_on:
      - nats
    networks:
      - internal

  nats:
    image: nats:2
    networks:
      - internal

  traefik:
    image: traefik:v2.1
    command:
      - --log.level=DEBUG
      # Enabling docker provider
      - --providers.docker=true
      # Traefik will listen to incoming request on entrypoint "websecure" to the port 3001 (HTTPS)
      - --entrypoints.websecure.address=:3001
      # Do not expose containers unless explicitly told so
      - --providers.docker.exposedbydefault=false

      # Traefik will listen to incoming request on entrypoint "dot-socket" to the port 853 (TLS)
      - --entryPoints.dot-socket.address=:853

      - --providers.file.directory=/configuration/
      - --providers.file.watch=true
      
    ports:
      # HTTPS server
      - 8443:3001
      # DoT (DNS-over-TLS on port 853)
      - 853:853
    volumes:
      # Bin the certificate folder to use custom certificates
      - ./certificates/:/certificates/:ro
      - ./certificates/certificates.toml:/configuration/certificates.toml
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - internal
      - default
  
  jaeger:
    image: jaegertracing/all-in-one:1.21
    environment:
      COLLECTOR_ZIPKIN_HTTP_PORT: 9411
    ports:
      - 16686:16686
    # labels:
      # - "traefik.enable=true"
      # - "traefik.http.routers.jaeger.rule=PathPrefix(`/jaeger`)"
      # - "traefik.http.services.jaeger.loadbalancer.server.port=16686"
    networks:
      - internal
      - default

networks:
  internal:

volumes:
  data:
