version: "3.3"

services:

  api-gw:
    build:
      context: .
    image: ghcr.io/iamfrench/nord-dns_api-gw
    env_file: docker-compose.env
    environment:
      SERVICES: api
      PORT: 3000
    depends_on:
      - nats # service registry
    labels:
      # Docker specific labels https://doc.traefik.io/traefik/routing/providers/docker/#specific-provider-options
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # Allow request only from the predefined entry point named "api-gw"
      - traefik.http.routers.api-gw_Router.entrypoints=api-gw
      # Create rule to match domaines localhost, ndns.cf & *.local.ndns.cf
      - traefik.http.routers.api-gw_Router.rule=HostRegexp(`localhost`, `ndns.cf`, `{subdomain:[a-z]+}.local.ndns.cf`)
      # Register service to use for this router
      - traefik.http.routers.api-gw_Router.service=api-gw_Service
      # Use TLS between the Traefik and the api-gw container
      # will terminate the TLS request
      - traefik.http.routers.api-gw_Router.tls=true
      
      # Tell Traefik to use the port 3000 to connect to `api` service
      # When Traefik Connecting to the Wrong Port: HTTP/502 Gateway Error
      # Even if we use a valid certificate, it doesn't includes an IP SANs
      # We have to disable traefik SSL verification (see traefic service command)
      - traefik.http.services.api-gw_Service.loadbalancer.server.port=3000
      - traefik.http.services.api-gw_Service.loadbalancer.server.scheme=https
      
      # Open Containers Annotations (used for GitHub packages and GitHub Container Registry)
      - org.opencontainers.image.source=https://github.com/IAmFrench/nord-dns
      - org.opencontainers.image.title="API Gateway"
      - org.opencontainers.image.description="Respond to incoming HTTPS traffic and packages query before forwarding to DoH service"
    networks:
      - internal
  
  redis:
    image: redis:alpine
    entrypoint: redis-server
    networks:
      - internal

  doh:
    build:
      context: .
    image: ghcr.io/iamfrench/nord-dns_doh
    env_file: docker-compose.env
    environment:
      SERVICES: doh.v1
    depends_on:
      - nats
      - redis
    labels:
      # Explicitly tell Traefik to expose this container
      - traefik.enable=true
      # Allow request only from the predefined entry point named "dot-socket"
      - traefik.http.routers.dot.entrypoints=dot-socket
      - traefik.tcp.routers.dot.tls.passthrough=true
      # Tell Traefik to use the port 853 to connect to `dot` service
      - traefik.http.services.dot.loadbalancer.server.port=853

      # Open Containers Annotations (used for GitHub packages and GitHub Container Registry)
      - org.opencontainers.image.source=https://github.com/IAmFrench/nord-dns
      - org.opencontainers.image.title="DNS-over-HTTPS Service"
      - org.opencontainers.image.description="Responds to DoH (DNS-over-HTTPS) request using built-in resolver"
    networks:
      - internal

  dot:
    build:
      context: .
    image: ghcr.io/iamfrench/nord-dns_dot
    env_file: docker-compose.env
    environment:
      SERVICES: dot.v1
    depends_on:
      - nats
      - redis
    labels:
      - traefik.enable=true
      # TCP config (working, but the service is unavailable (HTTP/503 Service unavailable))
      - traefik.tcp.routers.dot.entrypoints=dot-socket
      - traefik.tcp.routers.dot.rule=HostSNI(`*`)
      - traefik.tcp.routers.dot.service=dotService
      - traefik.tcp.services.dotService.loadbalancer.server.port=853
      - traefik.tcp.routers.dot.tls.passthrough=true

      # Open Containers Annotations (used for GitHub packages and GitHub Container Registry)
      - org.opencontainers.image.source=https://github.com/IAmFrench/nord-dns
      - org.opencontainers.image.title="DNS-over-TLS Service"
      - org.opencontainers.image.description="Responds to DoH (DNS-over-TLS) request using the DoH Service"
    networks:
      - internal

  filter:
    build:
      context: .
    image: ghcr.io/iamfrench/nord-dns_filter
    env_file: docker-compose.env
    environment:
      SERVICES: filter.v1
    depends_on:
      - nats
      - redis
    labels:
      - traefik.enable=false
      
      # Open Containers Annotations (used for GitHub packages and GitHub Container Registry)
      - org.opencontainers.image.source=https://github.com/IAmFrench/nord-dns
      - org.opencontainers.image.title="Filter Service"
      - org.opencontainers.image.description="Used to filter queries using blocklists such as 1Hosts and EasyList"
    networks:
      - internal

  nats:
    image: nats:latest
    labels:
      - traefik.enable=false
    networks:
      - internal

  traefik:
    image: traefik:latest
    restart: unless-stopped
    command:
      - --log.level=DEBUG

      ## Disable SSL verification
      # '500 Internal Server Error' caused by: x509: cannot validate certificate for 172.21.0.6 because it doesn't contain any IP SANs
      - --serversTransport.insecureSkipVerify=true


      ## Enabling Docker provider
      - --providers.docker=true
      # Do not expose containers unless explicitly told so
      - --providers.docker.exposedbydefault=false


      ## Enabling File provider
      - --providers.file.directory=/configuration/
      # Allow Traefik to automatically watch for file changes
      - --providers.file.watch=true


      # Enable Tracing to Jaeger
      - --tracing.jaeger=true
      - --tracing.jaeger.samplingServerURL=http://jaeger:5778/sampling
      - --tracing.jaeger.samplingType=const
      - --tracing.jaeger.samplingParam=1.0
      - --tracing.jaeger.localAgentHostPort=jaeger:6831
      - --tracing.jaeger.propagation=jaeger
      - --tracing.jaeger.traceContextHeaderName=uber-trace-id


      ## API-GW Entrypoint
      # Traefik will listen to incoming request on entrypoint "api-gw" to the port 3001 (HTTPS)
      - --entrypoints.api-gw.address=:3001
      

      ## DoT TLS Socket Entrypoint
      # Traefik will listen to incoming request on entrypoint "dot-socket" to the port 853 (TLS)
      - --entryPoints.dot-socket.address=:853


      ## Jaeger Entrypoint
      # Traefik will listen to incoming request on entrypoint "jaeger" to the port 16686 (HTTPS)
      - --entrypoints.jaeger.address=:16686   
      

      ## Trafik built-in Dashboard
      - --api.dashboard=true
      - --entrypoints.dashboard.address=:443
      # http://<Traefik IP>:8080/dashboard/
      # - --api.insecure=true
    ports:
      # HTTPS API Gateway (exposed:internal port)
      - 8443:3001
      # DoT (DNS-over-TLS on port 853)
      - 853:853
      # Jaeger Dashboard
      - 16686:16686
      # Traefik built-in Dashboard (not secure)
      - 8080:8080
      # Traefik secure Dashboard (secure)
      - 443:443
    volumes:
      # Bin the certificate folder to use custom certificates
      - ./certificates/:/certificates/:ro
      # Add certificate config for traefik
      - ./certificates/certificates.toml:/configuration/certificates.toml
      - ./traefik.toml:/configuration/traefik.toml
      # So that Traefik can listen to the Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      # - traefik.http.routers.dashboard.entrypoints=dot-socket
      - traefik.enable=true
      - traefik.http.routers.dashboard.entrypoints=dashboard
      - traefik.http.routers.dashboard.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/dashboard`))
      - traefik.http.routers.dashboard.tls=true
      - traefik.http.routers.dashboard.service=api@internal
    depends_on:
      - jaeger # for tracing
    networks:
      - internal
      - default
  
  jaeger:
    image: jaegertracing/all-in-one:latest
    environment:
      COLLECTOR_ZIPKIN_HTTP_PORT: 9411
    labels:
      - traefik.enable=true
      # TCP config (working, but the service is unavailable (HTTP/503 Service unavailable))
      - traefik.tcp.routers.jaeger.entrypoints=jaeger
      # Use * to allow non TLS request (https://doc.traefik.io/traefik/v2.0/routing/routers/#rule_1)
      - traefik.tcp.routers.jaeger.rule=HostSNI(`*`)
      - traefik.tcp.routers.jaeger.service=jaeger
      # Don't use TLS
      - traefik.tcp.routers.jaeger.tls=false
      - traefik.tcp.services.jaeger.loadbalancer.server.port=16686
      # - traefik.tcp.routers.jaeger.tls.passthrough=true
    networks:
      - internal

networks:
  internal:

# volumes:
#   data:
